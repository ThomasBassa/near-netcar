<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
		<!-- html, body, #picture { height: 100%; width: 50%; margin: 0; padding: 0;} -->
		<script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&libraries=drawing">// TODO REMOVE KEY and consolidate?
		</script>
		<script type ="text/javascript"
			src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz">
		</script>
		<script type="text/javascript"> //TODO separate into files
			//START AUTOBAHN
			var connection = new autobahn.Connection({
				url: 'ws://104.197.76.36:8080/ws',
				realm: 'realm1'
			});
			var mySession;
			var mode = "Manual";
			connection.onopen = function (session) {
				 // 1) subscribe to a topic
				function onevent(args) {
					console.log("Event:", args[0]);
				}
				session.subscribe('com.myapp.hello', onevent);

		  		 // 2) publish an event
				session.publish('com.myapp.hello', ['Hello, world!']);

				function accelerate(args) {
					return "accelerating!";
				}
				session.register('com.myapp.accelerate', accelerate);
				mySession=session;



			}
			function regCallDemo(){
				mySession.call('com.myapp.accelerate', [2, 3, 123, 421]).then(
					function (res) {
						console.log("Result:", res);
					}
				);
			}
			function rPCTest(){
				mySession.call('aero.near.joyMonitor', [-1]);
				// if(Math.random()>.5){
				// 	mySession.call('aero.near.joyMonitor', [Math.random()]);
				// }
				// else{
				// 	mySession.call('aero.near.joyMonitor', [Math.random()*-1]);
				// }
			}
			connection.open();
			//END AUTOBAHN
			//START GOOGLE MAPS
			var markers;
			var deleteListeners; // array to store listeners for marker deletion
			var listenersForDirections;
			var directionsDisplay;
			var directionsService = new google.maps.DirectionsService();
			var map;
			var waypoints;

			function initialize() {
				directionsDisplay = new google.maps.DirectionsRenderer();
				directionsDisplay.setMap(map);
				var myLatLng = new google.maps.LatLng(29.1886, -81.0487);
				var mapOptions = {
					zoom: 17,
					center: myLatLng
				};

				map = new google.maps.Map(document.getElementById('map-canvas'),
					mapOptions);

				
				// var helpWindow = new google.maps.InfoWindow({
				// 	content: 'Left Click to create a waypoint, Right Click to remove it!',
				// 	position: myLatLng
				// });

				// helpWindow.open(map);

				markers = new Array();

				deleteListeners = new Array();

				google.maps.event.addListener(map, 'click', function(e){ //UNCOMMENT LATER
					var mark = new google.maps.Marker({
						position: e.latLng,
						map: map,
						title: 'Waypoint',
						animation: google.maps.Animation.DROP
					});
					markers.push(mark);
					deleteListeners.push(google.maps.event.addListener(mark, 'rightclick', function(){
						marker.setMap(null);
					}));
				});

			}
			function loadScript() {
				var script = document.createElement('script');
				script.type = 'text/javascript';
				script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp' +
					'&signed_in=true&callback=initialize';
				document.body.appendChild(script);
			}
			function directionsStart() {
				listenersForDirections = new Array();
				for(i = 0; i < markers.length; i++){
					listenersForDirections.push(new google.maps.event.addListener(markers[i], 'click', beginDirecting(markers[i])));
				}
				// for each (var m in markers){
				// 	listenersForDirections.push(new google.maps.event.addListener(m, 'click', beginDirecting);
				// }
				//todo later
			}
			function beginDirecting(markerStart){
				waypoints = new Array();
				waypoints.push({
					location: markerStart.position
				});
				for(i = 1; i < markers.length; i++){
					google.maps.event.clearListeners(markers[i], 'click');
					listenersForDirections.push(new google.maps.event.addListener(markers[i], 'click', somethingToMakeThisWork(markers[i])));
				}
			}
			function somethingToMakeThisWork(m){
				document.getElementById("directionFinisher").disabled = false;
				waypoints.push({
					location: m.position
				});
			}
			function doneCollectingPoints(){
				var start = waypoints[0];
				var end = waypoints[waypoints.length-1];
				console.log(waypoints);
				var request = {
					origin: start.location,
					destination: end.location,
					travelMode: google.maps.TravelMode.WALKING,
					unitSystem: google.maps.UnitSystem.IMPERIAL,
					waypoints: waypoints.slice(1,waypoints.length-1),
					optimizeWaypoints: false,
					provideRouteAlternatives: false,
				};
				directionsService.route(request, function(response, status){
					if(status == google.maps.DirectionsStatus.OK){
						directionsDisplay.setDirections(response);
					}
					else
						console.log("I am stupid -- Jessica King");
				});
			}
			function helloWorld() {
				console.log("Hello World");
			}
			function changeMode() {   // will be for the checkbox thing
				if(mode == "Manual")
					mode = "Automatic";
				else
					mode = "Manual";
			}

			//window.onload = loadScript;
			google.maps.event.addDomListener(window, 'load', initialize);
			//END GOOGLE MAPS
		</script>
	</head>
	<body>
		<div id="map-canvas"></div>
		<div id="camera-canvas"></div>
		<div id="buttonland">
			<!--<form action="demo_form.asp">
			<input type="checkbox" name="Mode" value="Auto"> Automatic Mode<br> --><!-- TODO MAKE PUBSUB-->
				<!--<input type="submit" value="Submit">
			</form>-->
			<button type="button" class=buttonstyle>Automatic Mode</button>
			<button onclick="directionsStart()" class="buttonstyle">Give me Directions!</button>
			<button onclick="regCallDemo()" class=buttonstyle>Accelerate!(regcalldemo)</button>
			<button type="button" class=buttonstyle>I hate Javascript + Google Maps + my life</button>

			<button type="button" class=buttonstyle>Manual Mode</button>
			<button onclick="doneCollectingPoints()" disabled id="directionFinisher" class=buttonstyle>Done selecting waypoints?</button>
			<button onclick="rPCTest()" class=buttonstyle>RPC Test!</button>
			<button onclick="helloWorld()" class=buttonstyle>Hello World onclick test</button>
		</div>
	</body>
</html>