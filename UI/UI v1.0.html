<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
		<!-- html, body, #picture { height: 100%; width: 50%; margin: 0; padding: 0;} -->
		<script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&libraries=drawing">// TODO REMOVE KEY and consolidate?
		</script>
		<script type ="text/javascript"
			src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz">
		</script>
		<script type="text/javascript"> //TODO separate into files
			//START AUTOBAHN
			var connection = new autobahn.Connection({
				url: 'ws://104.197.76.36:8080/ws',
				realm: 'realm1'
			});
			var mySession;
			var mode = "Manual";
			connection.onopen = function (session) {
				 // 1) subscribe to a topic
				session.subscribe('aero.near.detect', detected); //subscribes to topic to see if object is detected
				session.subscribe('aero.near.carSpeed', speedUpdate);
				session.subscribe('aero.near.carPos',posUpdate);
		  		 // 2) publish an event
				session.publish('com.myapp.hello', ['Hello, world!']);

				function accelerate(args) {
					return "accelerating!";
				}
				session.register('com.myapp.accelerate', accelerate);
				mySession=session;



			}
			function regCallDemo(){
				mySession.call('com.myapp.accelerate', [2, 3, 123, 421]).then(
					function (res) {
						console.log("Result:", res);
					}
				);
			}
			function rPCTest(){
				mySession.call('aero.near.joyMonitor', [-1]);
				// if(Math.random()>.5){
				// 	mySession.call('aero.near.joyMonitor', [Math.random()]);
				// }
				// else{
				// 	mySession.call('aero.near.joyMonitor', [Math.random()*-1]);
				// }
			}
			connection.open();
			//END AUTOBAHN
			//START GOOGLE MAPS
										// var markers;
										// var deleteListeners; // array to store listeners for marker deletion
										// var listenersForDirections;
										// var directionsDisplay;
										// var directionsService = new google.maps.DirectionsService();
			var map;
										// var waypoints;
										// var ifDirecting = false;
										// var count;
										// var markerLatLngs;
										// var uniqueId;
			var myLatLng = new google.maps.LatLng(29.1886, -81.0487);
										// var carMarker;
										// var poly;


			function initialize() {
										// directionsDisplay = new google.maps.DirectionsRenderer();
										// directionsDisplay.setMap(map);
				var mapOptions = {
					zoom: 17,
					center: myLatLng,
					mapTypeId: google.maps.MapTypeId.TERRAIN
				};

				map = new google.maps.Map(document.getElementById('map-canvas'),
					mapOptions);
				icon = 'littlearrow.png';
				carMarker = new google.maps.Marker({
					position: myLatLng,
					map: map,
					title: 'Vehicle',
					icon: icon
				});
			}

										// markers = new Array();
										// listenersForDirections = new Array();
										// deleteListeners = new Array();
										// waypoints  = new Array();
										// markerLatLngs = new Array();

										// uniqueId = 0;
										// carMarker.id = uniqueId;
										// markers[0] = carMarker;
										// uniqueId++;

				
				


				//line making
										// var polyOptions = {
										// 	strokeColor: '#000000',
										// 	strokeOpacity: 1.0,
										// 	strokeWeight: 3
										// };

										// poly = new google.maps.Polyline(polyOptions);
										// poly.setMap(map);
										// var path = poly.getPath();
										// path.push(carMarker.position);


										// google.maps.event.addListener(map, 'click', function(e){ //UNCOMMENT LATER
										// 	var mark = new google.maps.Marker({
										// 		position: e.latLng,
										// 		map: map,
										// 		title: 'Waypoint',
										// 		animation: google.maps.Animation.DROP,
										// 	});
										// 	mark.id = uniqueId;
										// 	markers.push(mark);
										// 	uniqueId++;
										// 	var index = markers.indexOf(mark);
										// 	deleteListeners.push(google.maps.event.addListener(mark, 'rightclick', function(e){
										// 		deleteMarker(mark.id);
										// 	}));

										// 	var path = poly.getPath(); //temp to connect markers
										// 	path.push(e.latLng);
										// });
										// }
										// function deleteMarker(id) {
										// 	for (var i = 0; i < markers.length; i++) {
									 //            if (markers[i].id == id) {
									 //            	var path = poly.getPath();
									 //            	path.removeAt(i);
									 //                //Remove the marker from Map                  
									 //                markers[i].setMap(null);
									 // 				markers[i] = null;
									 //                //Remove the marker from array.
									 //                markers.splice(i, 1);
									 //                return;
							   //          		}
							   //      		}
										// }
			function loadScript() {
				var script = document.createElement('script');
				script.type = 'text/javascript';
				script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp' +
					'&signed_in=true&callback=initialize';
				document.body.appendChild(script);
			}

									// function directionsStart() {
									// 	ifDirecting = true;
									// 	count = 0;
									// 	document.getElementById("directionBeginner").disabled = true;

									// 	// for(i = 0; i < markers.length; i++){
									// 	// 	listenersForDirections.push(new google.maps.event.addListener(markers[i], 'click', somethingToMakeThisWork(markers[i])));
									// 	// }
									// 	for(var i = 0; i < markers.length; i++){
									// 		mark = markers[i];
									// 		// google.maps.event.clearListeners(markers[i], 'click');
									// 		listenersForDirections.push(google.maps.event.addListener(mark, 'click', somethingToMakeThisWork(mark)));
									// 	}
									// 	// for each (var m in markers){
									// 	// 	listenersForDirections.push(new google.maps.event.addListener(m, 'click', beginDirecting);
									// 	// }
									// 	//todo later
									// }
			// function beginDirecting(markerStart){
			// 	waypoints = new Array();
			// 	waypoints.push({
			// 		location: markerStart.position        ugly code, ignore it
			// 	});
			// 	for(i = 1; i < markers.length; i++){
			// 		google.maps.event.clearListeners(markers[i], 'click');
			// 		listenersForDirections.push(new google.maps.event.addListener(markers[i], 'click', somethingToMakeThisWork(markers[i])));
			// 	}
			// }
									// function somethingToMakeThisWork(m){
									// 	// count = count + 1;
									// 	// if(count>=2){
									// 		document.getElementById("directionFinisher").disabled = false;
									// 	// }
									// 	waypoints.push({
									// 		location: m.position
									// 	});
									// }
									// function doneCollectingPoints(){
									// 	var start = waypoints[0];
									// 	var end = waypoints[waypoints.length-1];
									// 	console.log(waypoints);
									// 	if(waypoints.length > 2){
									// 		var request = {
									// 			origin: start.location,
									// 			destination: end.location,
									// 			travelMode: google.maps.TravelMode.WALKING,
									// 			unitSystem: google.maps.UnitSystem.IMPERIAL,
									// 			waypoints: waypoints.slice(1,waypoints.length-1),
									// 			optimizeWaypoints: false,
									// 			provideRouteAlternatives: false
									// 		};
									// 		console.log("There are waypoints.");
									// 	} else {
									// 		var request = {
									// 			origin: start.location,
									// 			destination: end.location,
									// 			travelMode: google.maps.TravelMode.WALKING,
									// 			unitSystem: google.maps.UnitSystem.IMPERIAL,
									// 			optimizeWaypoints: false,
									// 			provideRouteAlternatives: false
									// 		};
									// 		console.log("There are no waypoints.");
									// 	}
									// 	directionsService.route(request, function(response, status){
									// 		if(status == google.maps.DirectionsStatus.OK){
									// 			directionsDisplay.setDirections(response);
									// 		}
									// 		else {
									// 			console.log("I am stupid -- Jessica King");
									// 		}
									// 	});
									// 	ifDirecting = false;
									// 	document.getElementById("directionBeginner").disabled = false;
									// 	document.getElementById("directionFinisher").disabled = true;
									// 	for (var i = 0; i < markers.length; i++) {
									// 		google.maps.event.clearListeners(markers[i], 'click');
									// 		listenersForDirections.pop();
									// 	}
									// 	waypoints.splice(0,waypoints.length);
									// }
			function helloWorld() {
				console.log("Hello World");
			}

			//window.onload = loadScript;
			google.maps.event.addDomListener(window, 'load', initialize);

			window.setInterval(refresh,33);


			var objectAvoidanceOverride = false;
			var timer;
			var speed = 0;

			var objWindow = new google.maps.InfoWindow({
				content: 'Object Detected!',
				position: myLatLng
			});

			function refresh() {
				console.log("refreshing");
				//publishing object avoidance checkbox status
				if(document.getElementById("switch1").checked == true&&objectAvoidanceOverride==false){
					console.log("checked");
					// mySession.call('aero.near.override', [true]);
					objectAvoidanceOverride = true;
					console.log("making timer");
					timer = window.setTimeout( function(){
						objectAvoidanceOverride = false;
						// mySession.call('aero.near.override', [false]);
						document.getElementById("switch1").checked = false;
						console.log("time's up");
					}, 20000);

				}
				else if(document.getElementById("switch1").checked == false && objectAvoidanceOverride == true){
					objectAvoidanceOverride = false;
					// mySession.call('aero.near.override', [false]);
					window.clearTimeout(timer);
				}

				document.getElementById("display").innerHTML = 
					"Latitude: "+myLatLng.lat()+"<br>Longitude: "+myLatLng.lng()+"<br>Speed: "+speed;

			}
			function detected (bool) { //bool is whether or not object is detected
				if(bool){
						
					objWindow.open(map);

				} else if (bool==false){

					objWindow.close();
				}

			}
			function speedUpdate (newSpeed) {
				speed = newSpeed;
			}
			function posUpdate(newLat, newLng){
				myLatLng = new google.maps.LatLng(newLat, newLng);
				map.setCenter(myLatLng);
			}
			function stop(){
				mySession.call('aero.near.emergStop', []);
			}
			//END GOOGLE MAPS
		</script>
	</head>
	<body>
		<div id="map-canvas"></div>
		<div id="camera-canvas"></div>
		<div id="buttonland">
			<!--<form action="demo_form.asp">
			<input type="checkbox" name="Mode" value="Auto"> Automatic Mode<br> --><!-- TODO MAKE PUBSUB-->
				<!--<input type="submit" value="Submit">
			</form>-->

			<p id="display" class="display">Latitude: Loading...\nLongitude: Loading...\nSpeed: Loading...</p>
			<img onclick="stop()" style="cursor:pointer;right:128px;float:right;" src="stopsign.png"/>
<!--			<button onclick="stop()" class=stop>Stop</button>-->
			<input type="checkbox" id="switch1" name="switch1" class="switch"/>
			<label for="switch1">Object Avoidance Override</label>



			<br></br>
			<!--<button onclick="overrideOn()" type="button" class=buttonstyle id="override">Object Avoidance Override</button>
			<button onclick="directionsStart()" id="directionBeginner" class="buttonstyle">Give me Directions!</button>
			<button onclick="regCallDemo()" class=buttonstyle>Accelerate!(regcalldemo)</button>
			<button type="button" class=buttonstyle>I hate Javascript + Google Maps + my life</button>

			<button type="button" class=buttonstyle>Manual Mode</button>
			<button onclick="doneCollectingPoints()" disabled id="directionFinisher" class=buttonstyle>Done selecting waypoints?</button>
			<button onclick="rPCTest()" class=buttonstyle>RPC Test!</button>
			<button onclick="helloWorld()" class=buttonstyle>Hello World onclick test</button>-->
		</div>
	</body>
</html>