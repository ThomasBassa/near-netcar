<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
		<!-- html, body, #picture { height: 100%; width: 50%; margin: 0; padding: 0;} -->
		<script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&libraries=drawing">// TODO REMOVE KEY and consolidate?
		</script>
		<script type ="text/javascript"
			src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz">
		</script>
		<script type="text/javascript"> //TODO separate into files
			//START AUTOBAHN
			var connection = new autobahn.Connection({
				url: 'ws://104.197.76.36:8080/ws',
				realm: 'realm1'
			});
			var mySession;
			var mode = "Manual";
			connection.onopen = function (session) {
				 // 1) subscribe to a topic
				session.subscribe('aero.near.detect', detected); //subscribes to topic to see if object is detected
				session.subscribe('aero.near.carSpeed', speedUpdate);
				session.subscribe('aero.near.carPos',posUpdate);
		  		 // 2) publish an event
				session.publish('com.myapp.hello', ['Hello, world!']);

				function accelerate(args) {
					return "accelerating!";
				}
				session.register('com.myapp.accelerate', accelerate);
				mySession=session;



			}
			function regCallDemo(){
				mySession.call('com.myapp.accelerate', [2, 3, 123, 421]).then(
					function (res) {
						console.log("Result:", res);
					}
				);
			}
			function rPCTest(){
				mySession.call('aero.near.joyMonitor', [-1]);
				// if(Math.random()>.5){
				// 	mySession.call('aero.near.joyMonitor', [Math.random()]);
				// }
				// else{
				// 	mySession.call('aero.near.joyMonitor', [Math.random()*-1]);
				// }
			}
			connection.open();
			//END AUTOBAHN
			//START GOOGLE MAPS
			var map;
			var myLatLng = new google.maps.LatLng(29.1886, -81.0487);

			function initialize() {
				var mapOptions = {
					zoom: 17,
					center: myLatLng,
					mapTypeId: google.maps.MapTypeId.TERRAIN
				};

				map = new google.maps.Map(document.getElementById('map-canvas'),
					mapOptions);
				icon = 'littlearrow.png';
				carMarker = new google.maps.Marker({
					position: myLatLng,
					map: map,
					title: 'Vehicle',
					icon: icon
				});
			}

			function loadScript() {
				var script = document.createElement('script');
				script.type = 'text/javascript';
				script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp' +
					'&signed_in=true&callback=initialize';
				document.body.appendChild(script);
			}

			function helloWorld() {
				console.log("Hello World");
			}

			//window.onload = loadScript;
			google.maps.event.addDomListener(window, 'load', initialize);

			window.setInterval(refresh,33);

			var objectAvoidanceOverride = false;
			var timer;
			var speed = 0;

			var objWindow = new google.maps.InfoWindow({
				content: 'Object Detected!',
				position: myLatLng
			});

			function refresh() {
				console.log("refreshing");
				//publishing object avoidance checkbox status
				if(document.getElementById("switch1").checked == true&&objectAvoidanceOverride==false){
					console.log("checked");
					// mySession.call('aero.near.override', [true]);
					objectAvoidanceOverride = true;
					console.log("making timer");
					timer = window.setTimeout( function(){
						objectAvoidanceOverride = false;
						// mySession.call('aero.near.override', [false]);
						document.getElementById("switch1").checked = false;
						console.log("time's up");
					}, 20000);

				}
				else if(document.getElementById("switch1").checked == false && objectAvoidanceOverride == true){
					objectAvoidanceOverride = false;
					// mySession.call('aero.near.override', [false]);
					window.clearTimeout(timer);
				}

				document.getElementById("display").innerHTML =
					"Latitude: "+myLatLng.lat()+"<br>Longitude: "+myLatLng.lng()+"<br>Speed: "+speed;

			}
			function detected (bool) { //bool is whether or not object is detected
				if(bool){
					objWindow.open(map);
				} else if (bool==false){
					objWindow.close();
				}

			}
			function speedUpdate (newSpeed) {
				speed = newSpeed;
			}
			function posUpdate(newLat, newLng){
				myLatLng = new google.maps.LatLng(newLat, newLng);
				map.setCenter(myLatLng);
			}
			function stop(){
				mySession.call('aero.near.emergStop', []);
			}
			//END GOOGLE MAPS
		</script>
	</head>
	<body>
		<div id="map-canvas"></div>
		<div id="camera-canvas"></div>
		<div id="buttonland">

			<p id="display" class="display">Latitude: Loading...\nLongitude: Loading...\nSpeed: Loading...</p>
			<img onclick="stop()" style="cursor:pointer;right:128px;float:right;" src="stopsign.png"/>
<!--			<button onclick="stop()" class=stop>Stop</button>-->
			<input type="checkbox" id="switch1" name="switch1" class="switch"/>
			<label for="switch1">Object Avoidance Override</label>
			
			<br></br>
		</div>
	</body>
</html>
